/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all
 * data is private to the user who created it. Access control is based on the
 * user's unique ID (`request.auth.uid`).
 *
 * Data Structure: The data is organized hierarchically under a top-level `users`
 * collection. Each user's data, including their cupping sessions and evaluations,
 * is stored under their own document path: `/users/{userId}/...`.
 * This structure is designed to be highly performant and secure, as it avoids
 * costly database lookups (`get()` calls) for authorization checks.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is explicitly granted.
 * - Authentication Required: No anonymous or public access is permitted. A user
 *   must be signed in to read or write any data.
 * - Strict Ownership: Users can only read, write, or query data that exists
 *   within their own `/users/{userId}` path. They cannot see or interact with
 *   data belonging to other users.
 * - Path-Based Security: Authorization is derived directly from the document path,
 *   comparing the `{userId}` wildcard to the authenticated user's ID. This is a
 *   simple, fast, and highly secure pattern.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document exists and the user is the owner.
     * CRITICAL: Used for all update and delete operations to prevent modifying
     * or deleting non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates relational integrity for a new CuppingSession on create.
     * Ensures the document's internal ID matches its path ID.
     */
    function hasValidCuppingSessionData(cuppingSessionId) {
      return request.resource.data.id == cuppingSessionId;
    }

    /**
     * Enforces immutability for critical fields of a CuppingSession on update.
     * Prevents the ownership link (ID) from being changed after creation.
     */
    function isImmutableCuppingSessionData() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates relational integrity for a new CuppingEvaluation on create.
     * Ensures the evaluation's ID and its parent session ID match the path.
     */
    function hasValidCuppingEvaluationData(cuppingSessionId, cuppingEvaluationId) {
      return request.resource.data.id == cuppingEvaluationId
          && request.resource.data.cuppingSessionId == cuppingSessionId;
    }

    /**
     * Enforces immutability for critical fields of a CuppingEvaluation on update.
     * Prevents relational links from being changed after creation.
     */
    function isImmutableCuppingEvaluationData() {
      return request.resource.data.id == resource.data.id
          && request.resource.data.cuppingSessionId == resource.data.cuppingSessionId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Secures the user's root document. This allows a user to
     *   create and manage their own user profile document, but prevents
     *   access by others.
     * @path /users/{userId}
     * @allow (create) A new user (auth.uid: 'user123') creates their profile at `/users/user123`.
     * @deny (get) Another user (auth.uid: 'user456') tries to read the profile at `/users/user123`.
     * @principle Establishes a secure, user-owned data root.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures cupping session documents. Only the user who owns
     *   the session (as determined by the path) can access or modify it.
     * @path /users/{userId}/cuppingSessions/{cuppingSessionId}
     * @allow (create) A user (auth.uid: 'user123') creates a session at `/users/user123/cuppingSessions/sessionABC`.
     * @deny (update) Another user (auth.uid: 'user456') tries to update the session at `/users/user123/cuppingSessions/sessionABC`.
     * @principle Restricts access to a user's own data tree and validates relational integrity.
     */
    match /users/{userId}/cuppingSessions/{cuppingSessionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidCuppingSessionData(cuppingSessionId);
      allow update: if isExistingOwner(userId) && isImmutableCuppingSessionData();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures cupping evaluation documents nested under a session.
     *   Access is inherited from the parent session, meaning only the session
     *   owner can manage these evaluations.
     * @path /users/{userId}/cuppingSessions/{cuppingSessionId}/cuppingEvaluations/{cuppingEvaluationId}
     * @allow (list) A user (auth.uid: 'user123') lists all evaluations for their session at `/users/user123/cuppingSessions/sessionABC`.
     * @deny (create) Another user (auth.uid: 'user456') tries to add an evaluation to `/users/user123/cuppingSessions/sessionABC`.
     * @principle Enforces inherited ownership from the parent document and validates relational integrity.
     */
    match /users/{userId}/cuppingSessions/{cuppingSessionId}/cuppingEvaluations/{cuppingEvaluationId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidCuppingEvaluationData(cuppingSessionId, cuppingEvaluationId);
      allow update: if isExistingOwner(userId) && isImmutableCuppingEvaluationData();
      allow delete: if isExistingOwner(userId);
    }
  }
}