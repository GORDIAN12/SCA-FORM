/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a user-ownership model for user profiles and a shared access model for cupping sessions.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profile information.
 * - /sessions/{sessionId}: Stores group cupping session data, including participant lists.
 * - /sessions/{sessionId}/evaluations/{evaluationId}: Stores individual evaluations within a session.
 * - /invitations/{invitationId}: Stores invitations to join cupping sessions.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Cupping sessions are accessible to members listed in the 'participantUids' array.
 * - Evaluations can only be created and managed by session participants.
 * - Invitations are publicly readable to facilitate simple lookup, but writes are restricted to admins.
 * - Listing users is disallowed for privacy.
 *
 * Denormalization for Authorization:
 * - CuppingSession documents include a 'participantUids' array to avoid needing a separate collection for membership.
 *
 * Structural Segregation:
 * - Public user profiles are stored in the top-level /users collection, separate from any potentially private user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (get) User A can read their own profile.
     * @allow (create) User A can create their own profile.
     * @allow (update) User A can update their own profile.
     * @allow (delete) User A can delete their own profile.
     * @deny (get) User A cannot read User B's profile.
     * @deny (create) User A cannot create User B's profile.
     * @deny (update) User A cannot update User B's profile.
     * @deny (delete) User A cannot delete User B's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to cupping session documents.
     * @path /sessions/{sessionId}
     * @allow (get) User A, who is a participant, can read the session.
     * @allow (create) User A can create a session if they set themselves as the admin.
     * @allow (update) User A, who is the admin, can update the session.
     * @allow (delete) User A, who is the admin, can delete the session.
     * @deny (get) User A, who is not a participant, cannot read the session.
     * @deny (create) User A cannot create a session without setting themselves as the admin.
     * @deny (update) User A, who is not the admin, cannot update the session.
     * @deny (delete) User A, who is not the admin, cannot delete the session.
     * @principle Enforces shared access based on the 'participantUids' array.
     */
    match /sessions/{sessionId} {
      allow get: if isSignedIn() && isSessionParticipant(sessionId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.adminUid == request.auth.uid;
      allow update: if isSignedIn() && isSessionAdmin(sessionId);
      allow delete: if isSignedIn() && isSessionAdmin(sessionId);
    }

    /**
     * @description Controls access to evaluation documents within a cupping session.
     * @path /sessions/{sessionId}/evaluations/{evaluationId}
     * @allow (get) User A, who is a participant in the session, can read an evaluation.
     * @allow (create) User A, who is a participant in the session, can create an evaluation.
     * @allow (update) User A, who is the author of the evaluation, can update it.
     * @allow (delete) User A, who is the author of the evaluation, can delete it.
     * @deny (get) User A, who is not a participant in the session, cannot read an evaluation.
     * @deny (create) User A, who is not a participant in the session, cannot create an evaluation.
     * @deny (update) User A, who is not the author of the evaluation, cannot update it.
     * @deny (delete) User A, who is not the author of the evaluation, cannot delete it.
     * @principle Enforces shared access for session participants and ownership for evaluation authors.
     */
    match /sessions/{sessionId}/evaluations/{evaluationId} {
      allow get: if isSignedIn() && isSessionParticipant(sessionId);
      allow list: if false;
      allow create: if isSignedIn() && isSessionParticipant(sessionId);
      allow update: if isSignedIn() && isEvaluationOwner(sessionId, evaluationId);
      allow delete: if isSignedIn() && isEvaluationOwner(sessionId, evaluationId);
    }

    /**
     * @description Controls access to invitation documents.
     * @path /invitations/{invitationId}
     * @allow (get) Any signed-in user can read an invitation (to check its status).
     * @allow (create) Only a session admin can create an invitation.
     * @allow (update) Only a session admin can update an invitation.
     * @allow (delete) Only a session admin can delete an invitation.
     * @deny (create) A non-admin user cannot create an invitation.
     * @deny (update) A non-admin user cannot update an invitation.
     * @deny (delete) A non-admin user cannot delete an invitation.
     * @principle Allows public read access for invitation lookup but restricts write access to session admins.
     */
    match /invitations/{invitationId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && isSessionAdmin(request.resource.data.sessionId);
      allow update: if isSignedIn() && isSessionAdmin(resource.data.sessionId);
      allow delete: if isSignedIn() && isSessionAdmin(resource.data.sessionId);
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }

    function isSessionAdmin(sessionId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId)).data.adminUid == request.auth.uid;
    }

    function isSessionParticipant(sessionId) {
        return exists(/databases/$(database)/documents/sessions/$(sessionId)) && get(/databases/$(database)/documents/sessions/$(sessionId)).data.participantUids.hasAny([request.auth.uid]);
    }

    function isEvaluationOwner(sessionId, evaluationId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId)/evaluations/$(evaluationId)).data.userId == request.auth.uid;
    }
  }
}